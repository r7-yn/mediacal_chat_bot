import streamlit as st
from openai import OpenAI

# إعداد الاتصال بـ OpenRouter API
client = OpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key="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",
)

# واجهة المستخدم باستخدام Streamlit
st.title("تشخيص طبي باستخدام الذكاء الاصطناعي")
st.write("""
    هذا التطبيق يستخدم الذكاء الاصطناعي لتقديم التشخيصات الطبية بناءً على الملاحظات التي يقدمها الطبيب.
    من فضلك، أدخل الملاحظات الطبية للمريض أدناه.
""")

# إدخال الملاحظات من الطبيب
vis_note = st.text_area("أدخل ملاحظات الطبيب:")

if st.button("احصل على التشخيص"):
    if vis_note:
        # البرومبت لتوجيه الاستفسار (التشخيص الطبي)
        prompt = f"""
        أنت طبيب مختص في الباطنية. سيتم إعطاؤك ملاحظات طبية كتبها طبيب آخر، وتشمل شكوى المريض والأعراض والنتائج المخبرية. بناءً على هذه المعلومات:

        مهمتك:
        1. **التشخيص الطبي المحتمل بدقة عالية**:
           - بناءً على الملاحظات والأعراض، قدّم تشخيصًا محتملاً دقيقًا، مع ذكر الأسباب المحتملة لكل تشخيص إذا لزم الأمر.
           - في حال وجود أكثر من تشخيص، قدم تبريرًا لاختيار كل واحد.
           - قم بتحديد **كود ICD المناسب** لكل تشخيص (تأكد من أن الأكواد دقيقة ومناسبة).

        2. **خطة العلاج المبدئية**:
           - قدم خطة علاجية واضحة تشمل الأدوية المناسبة بناءً على التشخيص. 
           - حدد **الجرعة** والـ **مدة العلاج** لكل دواء بشكل دقيق.
           - إذا كان هناك تفاعلات دوائية محتملة بين الأدوية الحالية للمريض، قم بتوضيح ذلك واقترح تعديلات إذا لزم الأمر.

        3. **أسئلة إضافية لتحسين دقة التشخيص**:
           - طرح أسئلة إضافية مهمة للمريض أو لإجراء فحوصات مخبرية تكميلية قد تُساعد في توضيح التشخيص بشكل أدق.
           - هل هناك أعراض أو فحوصات إضافية ينبغي النظر فيها لتحديد التشخيص بشكل دقيق؟ مثل الفحوصات المتعلقة بالغدة الدرقية أو مستوى الإنزيمات العضلية.

        الملاحظات الطبية:
        {vis_note}
        """
        
        # استدعاء OpenRouter API للحصول على التشخيص
        completion = client.chat.completions.create(
            extra_headers={
                "HTTP-Referer": "<YOUR_SITE_URL>",  # اختياري
                "X-Title": "<YOUR_SITE_NAME>",  # اختياري
            },
            extra_body={},
            model="deepseek/deepseek-r1-0528:free",
            messages=[
                {"role": "user", "content": prompt}
            ]
        )

        # عرض التشخيص الطبي للمستخدم
        st.subheader("نتيجة التشخيص:")
        st.write(completion.choices[0].message.content)
    else:
        st.error("من فضلك أدخل ملاحظات الطبيب أولاً.")
